{% extends 'base.html' %}

{% block title %}R√©sultats du Quiz - {{ quiz.title }} - EduQuiz{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Added back button with navy theme -->
    <div class="mb-6">
        <button onclick="history.back()" class="bg-white text-slate-700 px-4 py-2 rounded-lg shadow-sm hover:shadow-md transition-all duration-200 border border-gray-200">
            <i class="fas fa-arrow-left mr-2"></i>Retour
        </button>
    </div>

    <!-- Header avec r√©sultat principal -->
    <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-24 h-24 bg-green-100 rounded-full mb-4">
            {% if score_percentage >= excellent_threshold %}
                <i class="fas fa-trophy text-green-600 text-3xl"></i>
            {% elif score_percentage >= good_threshold %}
                <i class="fas fa-medal text-yellow-600 text-3xl"></i>
            {% else %}
                <i class="fas fa-certificate text-blue-600 text-3xl"></i>
            {% endif %}
        </div>
        <h1 class="text-4xl font-bold text-gray-900 mb-2">
            {% if score_percentage >= excellent_threshold %}
                F√©licitations ! üéâ
            {% elif score_percentage >= good_threshold %}
                Bon travail ! üëè
            {% else %}
                Quiz termin√© ! üìö
            {% endif %}
        </h1>
        <p class="text-xl text-gray-600">Tu as termin√© le quiz "{{ quiz.title }}"</p>
    </div>

    <!-- R√©sultats principaux -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-percentage text-green-600 text-2xl"></i>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-2">
                {{ score_percentage|floatformat:0 }}%
            </div>
            <div class="text-gray-600">Score final</div>
            <div class="text-sm font-medium mt-1
                {% if score_percentage >= excellent_threshold %}text-green-600
                {% elif score_percentage >= good_threshold %}text-yellow-600
                {% else %}text-blue-600{% endif %}">
                {% if score_percentage >= excellent_threshold %}
                    Excellent travail !
                {% elif score_percentage >= good_threshold %}
                    Bien jou√© !
                {% else %}
                    Continue tes efforts !
                {% endif %}
            </div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="w-16 h-16 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-clock text-blue-600 text-2xl"></i>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-2">
                {% if attempt.time_taken %}
                    {{ attempt.time_taken|time:"i:s" }}
                {% else %}
                    --:--
                {% endif %}
            </div>
            <div class="text-gray-600">Temps utilis√©</div>
            <div class="text-sm text-blue-600 font-medium mt-1">Sur {{ quiz.time_limit }} minutes</div>
        </div>
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 text-center">
            <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-star text-yellow-600 text-2xl"></i>
            </div>
            <div class="text-3xl font-bold text-gray-900 mb-2">+{{ attempt.score }}</div>
            <div class="text-gray-600">Points gagn√©s</div>
            <div class="text-sm text-yellow-600 font-medium mt-1">Total: {{ user.points }}</div>
        </div>
    </div>

    <!-- D√©tails des r√©ponses -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-900 mb-6">D√©tail de tes r√©ponses</h2>
        
        <div class="space-y-4">
            {% for answer in answers %}
            <div class="flex items-start p-4 
                {% if answer.is_correct %}bg-green-50 border border-green-200
                {% else %}bg-red-50 border border-red-200{% endif %} rounded-lg">
                <div class="flex-shrink-0">
                    <div class="w-8 h-8 rounded-full flex items-center justify-center
                        {% if answer.is_correct %}bg-green-500{% else %}bg-red-500{% endif %}">
                        <i class="fas {% if answer.is_correct %}fa-check{% else %}fa-times{% endif %} text-white text-sm"></i>
                    </div>
                </div>
                <div class="ml-4 flex-1">
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="font-semibold text-gray-900">Question {{ forloop.counter }}</h3>
                        <span class="text-sm font-medium
                            {% if answer.is_correct %}text-green-600{% else %}text-red-600{% endif %}">
                            {% if answer.is_correct %}+{{ answer.points_earned }}{% else %}0{% endif %} points
                        </span>
                    </div>
                    <p class="text-gray-700 mb-2">{{ answer.question.question_text }}</p>
                    
                    {% if answer.question.question_type == 'mcq' %}
                        <div class="text-sm space-y-1">
                            <div>
                                <span class="{% if answer.is_correct %}text-green-600{% else %}text-red-600{% endif %} font-medium">
                                    Ta r√©ponse: {{ answer.selected_choice.choice_text }}
                                </span>
                                <span class="{% if answer.is_correct %}text-green-500{% else %}text-red-500{% endif %} ml-4">
                                    {% if answer.is_correct %}‚úì Correct{% else %}‚úó Incorrect{% endif %}
                                </span>
                            </div>
                            {% if not answer.is_correct %}
                                {% for choice in answer.question.choices.all %}
                                    {% if choice.is_correct %}
                                        <div><span class="text-green-600 font-medium">Bonne r√©ponse: {{ choice.choice_text }}</span></div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% elif answer.question.question_type == 'open' %}
                        <div class="text-sm space-y-1">
                            <div><span class="text-blue-600 font-medium">Ta r√©ponse:</span> "{{ answer.open_answer }}"</div>
                        </div>
                    {% elif answer.question.question_type == 'true_false' %}
                        <div class="text-sm space-y-1">
                            <div>
                                <span class="{% if answer.is_correct %}text-green-600{% else %}text-red-600{% endif %} font-medium">
                                    Ta r√©ponse: {% if answer.true_false_answer %}Vrai{% else %}Faux{% endif %}
                                </span>
                                <span class="{% if answer.is_correct %}text-green-500{% else %}text-red-500{% endif %} ml-4">
                                    {% if answer.is_correct %}‚úì Correct{% else %}‚úó Incorrect{% endif %}
                                </span>
                            </div>
                            {% if not answer.is_correct %}
                                {% for choice in answer.question.choices.all %}
                                    {% if choice.is_correct %}
                                        <div><span class="text-green-600 font-medium">Bonne r√©ponse: {% if choice.choice_text == 'True' %}Vrai{% else %}Faux{% endif %}</span></div>
                                    {% endif %}
                                {% endfor %}
                            {% endif %}
                        </div>
                    {% endif %}
                    
                    {% if answer.question.explanation %}
                        <div class="mt-2 p-3 bg-blue-50 rounded-lg">
                            <p class="text-sm text-blue-800">
                                <i class="fas fa-info-circle mr-1"></i>
                                <strong>Explication:</strong> {{ answer.question.explanation }}
                            </p>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>

    <!-- Actions -->
    <div class="flex flex-col sm:flex-row gap-4 justify-center mb-8">
        <!-- Updated buttons with navy theme -->
        <a href="{% url 'quiz_catalog' %}" 
           class="px-8 py-3 bg-navy-900 text-white rounded-lg hover:bg-navy-800 transition-colors font-medium text-center">
            <i class="fas fa-list mr-2"></i>
            D√©couvrir d'autres quiz
        </a>
        <a href="{% url 'quiz_play' quiz.id %}" 
           class="px-8 py-3 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors font-medium text-center">
            <i class="fas fa-redo mr-2"></i>
            Refaire ce quiz
        </a>
    </div>

    <!-- Quiz recommand√©s -->
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h2 class="text-xl font-bold text-gray-900 mb-6 flex items-center">
            <i class="fas fa-lightbulb text-yellow-500 mr-2"></i>
            Quiz recommand√©s pour toi
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            {% for recommended_quiz in recommended_quizzes %}
            <div class="border border-gray-200 rounded-lg p-4 hover:shadow-md transition-shadow">
                <div class="flex items-center justify-between mb-2">
                    <span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded-full">
                        {{ recommended_quiz.subject.name }}
                    </span>
                    <span class="text-xs text-gray-500">{{ recommended_quiz.level }}</span>
                </div>
                <h3 class="font-semibold text-gray-900 mb-2">{{ recommended_quiz.title }}</h3>
                <p class="text-sm text-gray-600 mb-3">{{ recommended_quiz.description|truncatewords:15 }}</p>
                <div class="flex items-center justify-between">
                    <div class="flex items-center text-xs text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        {{ recommended_quiz.time_limit }} min
                        <i class="fas fa-question-circle ml-2 mr-1"></i>
                        {{ recommended_quiz.questions.count }} questions
                    </div>
                    <!-- Updated button with navy theme -->
                    <a href="{% url 'quiz_play' recommended_quiz.id %}" 
                       class="bg-navy-900 text-white px-3 py-1 rounded text-xs hover:bg-navy-800 transition-colors">
                        Commencer
                    </a>
                </div>
            </div>
            {% empty %}
            <div class="col-span-full text-center py-8">
                <i class="fas fa-search text-gray-400 text-3xl mb-4"></i>
                <p class="text-gray-600">Aucun quiz recommand√© pour le moment.</p>
                <a href="{% url 'quiz_catalog' %}" class="text-navy-900 hover:underline">
                    Explore tous les quiz disponibles
                </a>
            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}
