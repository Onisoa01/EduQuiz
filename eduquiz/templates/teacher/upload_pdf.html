{% extends 'base.html' %}

{% block title %}Téléverser un PDF - EduQuiz{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-900">Téléverser un cours PDF</h1>
        <p class="text-gray-600 mt-2">L'IA analysera automatiquement votre document pour générer des quiz adaptés</p>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-8">
        <form method="post" enctype="multipart/form-data" class="space-y-6" id="upload-form">
            {% csrf_token %}
            
            <!-- Zone de téléversement -->
            <div class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center hover:border-primary transition-colors" 
                 id="drop-zone">
                <div class="space-y-4" id="upload-area">
                    <div class="mx-auto w-16 h-16 bg-primary/10 rounded-full flex items-center justify-center">
                        <i class="fas fa-file-pdf text-primary text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900">Glissez-déposez votre fichier PDF ici</h3>
                        <p class="text-gray-600">ou cliquez pour sélectionner un fichier</p>
                    </div>
                    {{ form.pdf_file }}
                    <label for="id_pdf_file" 
                           class="inline-flex items-center px-6 py-3 border border-primary text-primary bg-white hover:bg-primary hover:text-white rounded-lg font-medium cursor-pointer transition-colors">
                        <i class="fas fa-upload mr-2"></i>
                        Choisir un fichier
                    </label>
                    <p class="text-sm text-gray-500">Taille maximale: 10 MB • Formats acceptés: PDF</p>
                </div>
                
                <div class="hidden space-y-4" id="file-preview">
                    <div class="mx-auto w-16 h-16 bg-green-100 rounded-full flex items-center justify-center">
                        <i class="fas fa-check text-green-600 text-2xl"></i>
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold text-gray-900" id="file-name"></h3>
                        <p class="text-gray-600" id="file-size"></p>
                    </div>
                    <button type="button" onclick="resetFileUpload()" 
                            class="text-primary hover:text-primary/80 text-sm font-medium">
                        Changer de fichier
                    </button>
                </div>
            </div>

            <!-- Display form errors if any -->
            {% if form.errors %}
                <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                    <div class="flex">
                        <div class="flex-shrink-0">
                            <i class="fas fa-exclamation-circle text-red-400"></i>
                        </div>
                        <div class="ml-3">
                            <h3 class="text-sm font-medium text-red-800">Erreurs dans le formulaire :</h3>
                            <div class="mt-2 text-sm text-red-700">
                                {% for field, errors in form.errors.items %}
                                    <p><strong>{{ field }}:</strong> {{ errors|join:", " }}</p>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Informations du cours -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="{{ form.subject.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Matière <span class="text-red-500">*</span>
                    </label>
                    <!-- Added better styling and validation for subject field -->
                    {% if form.subject.field.queryset.count > 0 %}
                        <select name="subject" id="id_subject" 
                                class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                                required>
                            <option value="">Sélectionnez une matière</option>
                            {% for subject in form.subject.field.queryset %}
                                <option value="{{ subject.pk }}" 
                                        {% if form.subject.value == subject.pk %}selected{% endif %}>
                                    {{ subject.name }}
                                </option>
                            {% endfor %}
                        </select>
                    {% else %}
                        <div class="w-full px-4 py-2 border border-red-300 rounded-lg bg-red-50">
                            <p class="text-red-600 text-sm">
                                <i class="fas fa-exclamation-triangle mr-2"></i>
                                Aucune matière disponible. Contactez l'administrateur pour ajouter des matières.
                            </p>
                        </div>
                        <input type="hidden" name="subject" value="">
                    {% endif %}
                    {% if form.subject.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.subject.errors|join:", " }}</p>
                    {% endif %}
                </div>

                <div>
                    <label for="{{ form.level.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                        Niveau <span class="text-red-500">*</span>
                    </label>
                    <!-- Added better styling for level field -->
                    <select name="level" id="id_level" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                            required>
                        <option value="">Sélectionnez un niveau</option>
                        <option value="6eme" {% if form.level.value == "6eme" %}selected{% endif %}>6ème</option>
                        <option value="5eme" {% if form.level.value == "5eme" %}selected{% endif %}>5ème</option>
                        <option value="4eme" {% if form.level.value == "4eme" %}selected{% endif %}>4ème</option>
                        <option value="3eme" {% if form.level.value == "3eme" %}selected{% endif %}>3ème</option>
                        <option value="2nde" {% if form.level.value == "2nde" %}selected{% endif %}>2nde</option>
                        <option value="1ere" {% if form.level.value == "1ere" %}selected{% endif %}>1ère</option>
                        <option value="terminale" {% if form.level.value == "terminale" %}selected{% endif %}>Terminale</option>
                    </select>
                    {% if form.level.errors %}
                        <p class="mt-1 text-sm text-red-600">{{ form.level.errors|join:", " }}</p>
                    {% endif %}
                </div>
            </div>

            <div>
                <label for="{{ form.title.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                    Titre du cours <span class="text-red-500">*</span>
                </label>
                <!-- Added better styling for title field -->
                <input type="text" name="title" id="id_title" 
                       class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                       placeholder="Ex: Les équations du second degré"
                       value="{{ form.title.value|default:'' }}"
                       required>
                {% if form.title.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.title.errors|join:", " }}</p>
                {% endif %}
            </div>

            <div>
                <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">Description (optionnel)</label>
                <!-- Added better styling for description field -->
                <textarea name="description" id="id_description" rows="3"
                          class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-colors"
                          placeholder="Décrivez brièvement le contenu du cours...">{{ form.description.value|default:'' }}</textarea>
                {% if form.description.errors %}
                    <p class="mt-1 text-sm text-red-600">{{ form.description.errors|join:", " }}</p>
                {% endif %}
            </div>

            <!-- Actions -->
            <div class="flex items-center justify-between pt-6 border-t border-gray-200">
                <a href="{% url 'teacher_dashboard' %}" 
                   class="px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors">
                    Annuler
                </a>
                <button type="submit" id="submit-btn"
                        class="px-8 py-2 bg-primary text-white rounded-lg hover:bg-primary/90 transition-colors font-medium disabled:opacity-50 disabled:cursor-not-allowed">
                    <i class="fas fa-upload mr-2"></i>
                    <span id="submit-text">Téléverser le fichier</span>
                </button>
            </div>
        </form>
    </div>

    <!-- Informations sur le processus -->
    <div class="mt-8 bg-blue-50 border border-blue-200 rounded-lg p-6">
        <div class="flex items-start">
            <div class="flex-shrink-0">
                <i class="fas fa-info-circle text-blue-600 text-xl"></i>
            </div>
            <div class="ml-4">
                <h3 class="text-lg font-semibold text-blue-900">Comment ça marche ?</h3>
                <div class="mt-2 text-blue-800 space-y-2">
                    <p>1. <strong>Téléversement</strong> : Sélectionnez votre fichier PDF</p>
                    <p>2. <strong>Création du quiz</strong> : Configurez les paramètres de base</p>
                    <p>3. <strong>Génération IA</strong> : L'IA analyse le contenu et propose des questions</p>
                    <p>4. <strong>Validation</strong> : Vous modifiez et validez les questions avant publication</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const dropZone = document.getElementById('drop-zone');
    const fileInput = document.getElementById('id_pdf_file'); // Use correct ID from Django form
    const uploadArea = document.getElementById('upload-area');
    const filePreview = document.getElementById('file-preview');
    const fileName = document.getElementById('file-name');
    const fileSize = document.getElementById('file-size');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const form = document.getElementById('upload-form');

    // Drag and drop handlers
    dropZone.addEventListener('dragover', function(e) {
        e.preventDefault();
        dropZone.classList.add('border-primary', 'bg-primary/5');
    });

    dropZone.addEventListener('dragleave', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-primary', 'bg-primary/5');
    });

    dropZone.addEventListener('drop', function(e) {
        e.preventDefault();
        dropZone.classList.remove('border-primary', 'bg-primary/5');
        
        const files = e.dataTransfer.files;
        if (files.length > 0) {
            handleFileSelect(files[0]);
        }
    });

    // File input change handler
    fileInput.addEventListener('change', function(e) {
        if (e.target.files.length > 0) {
            handleFileSelect(e.target.files[0]);
        }
    });

    // Handle file selection
    function handleFileSelect(file) {
        console.log('[v0] File selected:', file.name, file.size, file.type);
        
        // Validate file type
        if (file.type !== 'application/pdf') {
            window.showNotification('Veuillez sélectionner un fichier PDF.', 'warning');
            return;
        }

        // Validate file size (10MB max)
        const maxSize = 10 * 1024 * 1024; // 10MB
        if (file.size > maxSize) {
            window.showNotification('Le fichier est trop volumineux. Taille maximale: 10 MB.', 'error');
            return;
        }

        // Update file input
        const dt = new DataTransfer();
        dt.items.add(file);
        fileInput.files = dt.files;

        // Show file preview
        fileName.textContent = file.name;
        fileSize.textContent = formatFileSize(file.size);
        uploadArea.classList.add('hidden');
        filePreview.classList.remove('hidden');
        
        console.log('[v0] File preview updated');
    }

    // Reset file upload
    window.resetFileUpload = function() {
        fileInput.value = '';
        uploadArea.classList.remove('hidden');
        filePreview.classList.add('hidden');
        console.log('[v0] File upload reset');
    };

    // Format file size
    function formatFileSize(bytes) {
        if (bytes === 0) return '0 Bytes';
        const k = 1024;
        const sizes = ['Bytes', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // Form submission handler
    form.addEventListener('submit', function(e) {
        console.log('[v0] Form submission started');
        
        // Check if file is selected
        if (!fileInput.files.length) {
            e.preventDefault();
            window.showNotification('Veuillez sélectionner un fichier PDF.', 'warning');
            return;
        }

        const title = document.getElementById('id_title').value.trim();
        const subject = document.getElementById('id_subject').value;
        const level = document.getElementById('id_level').value;
        
        if (!title) {
            e.preventDefault();
            window.showNotification('Veuillez saisir un titre pour le cours.', 'warning');
            document.getElementById('id_title').focus();
            return;
        }
        
        if (!subject) {
            e.preventDefault();
            window.showNotification('Veuillez sélectionner une matière.', 'warning');
            document.getElementById('id_subject').focus();
            return;
        }
        
        if (!level) {
            e.preventDefault();
            window.showNotification('Veuillez sélectionner un niveau.', 'warning');
            document.getElementById('id_level').focus();
            return;
        }

        // Disable submit button and show loading
        submitBtn.disabled = true;
        submitText.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Téléversement en cours...';
        
        console.log('[v0] Form data being submitted:', {
            file: fileInput.files[0].name,
            title: title,
            subject: subject,
            level: level
        });
    });

    console.log('[v0] PDF upload JavaScript initialized');
});
</script>
{% endblock %}
